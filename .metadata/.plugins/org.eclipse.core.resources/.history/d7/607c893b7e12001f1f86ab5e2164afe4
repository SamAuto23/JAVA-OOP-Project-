package Shop;

import java.util.ArrayList;
import java.util.Comparator;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

public class Customer extends User {
    private ShoppingBasket basket;
    private StockManager stockManager;

    public Customer(String userId, String username, String name, Address address, String role) {
        super(userId, username, name, address, role);
        this.basket = new ShoppingBasket();
        this.stockManager = StockManager.getInstance();
    }

    @Override
    public void displayOptions() {
        System.out.println("Customer Options:");
        System.out.println("1. View Products");
        System.out.println("2. Add Product to Basket");
        System.out.println("3. View Basket");
        System.out.println("4. Cancel Basket");
        System.out.println("5. Search Products");
        System.out.println("6. Complete Payment");
    }

    public void viewProducts() {
        List<Product> products = stockManager.getStock();
        products.sort(Comparator.comparingDouble(Product::getRetailPrice));
        for (Product product : products) {
            System.out.println(product.displayWithoutCost());
        }
    }

    public void addToBasket(String barcode) {
        if (barcode.length() != 6 || !barcode.matches("\\d+")) {
            System.out.println("Invalid barcode. It must be a 6-digit string.");
            return;
        }

        List<Product> products = stockManager.getStock();
        Optional<Product> product = products.stream()
            .filter(p -> Integer.toString(p.getBarcode()).equals(barcode))
            .findFirst();

        if (product.isPresent()) {
            if (product.get().getQuantityInStock() > 0) {
                basket.addItem(product.get());
                System.out.println("Added " + product.get().getBrand() + " to your basket.");
            } else {
                System.out.println("This product is out of stock.");
            }
        } else {
            System.out.println("Product not found.");
        }
    }

    public void viewBasket() {
        basket.viewItems();
    }

    public void cancelBasket() {
        basket.clearBasket();
        System.out.println("Basket has been canceled.");
    }

    public void completePayment(PaymentMethod paymentMethod) {
        double totalAmount = basket.getTotalAmount();
        Receipt receipt = paymentMethod.processPayment(totalAmount, getAddress());
        System.out.println(receipt);
        stockManager.updateStock(basket.getItems());
        basket.clearBasket();
    }

    public List<Product> searchProducts(String criteria, String value) {
        if (criteria.equalsIgnoreCase("barcode") && (value.length() != 6 || !value.matches("\\d+"))) {
            System.out.println("Invalid barcode. It must be a 6-digit string.");
            return new ArrayList<>();
        }

        List<Product> products = stockManager.getStock();
        List<Product> filteredProducts = new ArrayList<>();
        switch (criteria.toLowerCase()) {
            case "barcode":
                filteredProducts = products.stream()
                    .filter(p -> Integer.toString(p.getBarcode()).equals(value))
                    .collect(Collectors.toList());
                break;
            case "mouse_buttons":
                filteredProducts = products.stream()
                    .filter(p -> p instanceof Mouse && Integer.toString(((Mouse) p).getNumberOfButtons()).equals(value))
                    .collect(Collectors.toList());
                break;
            default:
                System.out.println("Invalid search criteria.");
                break;
        }
        return filteredProducts;
    }
}
